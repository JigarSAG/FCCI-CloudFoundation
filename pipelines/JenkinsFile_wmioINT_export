#!/usr/bin/env groovy

pipeline 
{
    agent any 
    environment 
	{
	// initialize the variables
		branch="${branchName}"
		apis = ""		
 	}

    stages 
	{
	 stage('Initialize Repo')
	  {  
	   steps 
		{
		  script {
			iPaasEnv = "wmioINT"
			wmioenv = "DEV"
			echo "${iPaasEnv}"

			
			source_environment_hostname = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i hostname | cut -d '"' -f2 ''' ).trim()
			source_environment_port = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i port | cut -d '"' -f2 ''' ).trim()
			admin_user = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i admin_username | cut -d '"' -f2 ''' ).trim()
			source_type = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i type | cut -d '"' -f2 ''' ).trim()
			//repo_user = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/repo.yml | grep -i user | cut -d '"' -f2 ''' ).trim()
			LOCAL_DEV_URL = "https://${source_environment_hostname}:${source_environment_port}"
        //    onprem_user = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_username | cut -d '"' -f2 ''' ).trim()  
        //    onprem_pwd = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_pwd | cut -d '"' -f2 ''' ).trim() 
        //    onpremurl = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_url | cut -d '"' -f2 ''' ).trim()
        //    onpremport = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_prt | cut -d '"' -f2 ''' ).trim()
        //    inturl="${onpremurl}:${onpremport}"
		
			repo_user="JigarBharat.Shah@Softwareag.com"
			onprem_user="Administrator"
			onprem_pwd="manage"
			inturl="http://SAG-FMJB2F3:5401"
			}
			
		echo "${source_environment_hostname}"
		echo "${source_environment_port}"
    	echo "${admin_user}"
		echo "${source_type}"
		echo "${repo_user}"
        echo "${onprem_user}"
		echo "${onprem_pwd}"
		echo "${inturl}"
		
		}
	   }
	
	
	stage('Export Projects')
	 {
         steps {
		            sh 'pwd'
		            sh 'ls -lrt'

		            
                      		echo "Start exporting the project"
						script{
                            
							env.premurl=inturl
							echo "on-prem url is : ${premurl}"
							
							env.ioIntUrl=LOCAL_DEV_URL
							echo "io INT url is : ${ioIntUrl}"

			                dir('FCCI-CloudFoundation')
							{ 
		   			        sh 'pwd'
	   	   			        sh 'ls -ltr' 		
								echo "checkout"
							script {
								git branch: 'DEV',
								credentialsId: 'webm_credentials',
								url: 'https://github.com/JigarSAG/FCCI-CloudFoundation.git'

								sh "ls -lat"
				                	}
							
							
								if ("${projectName}" == '')
								{
									echo "Project name is not given"
                                	exit 0
								}
                            	else
								{
								echo "Project name is ${projectName}"
								
								sh '''
								echo $(pwd)
								echo $premurl

								cd export
								echo $(pwd)
								echo $(ls -lrt)

                               					cd project
								echo $(pwd)
								echo $(ls -lrt)

								echo ${ioIntUrl}
								echo ${premurl}

                        		##curl --location 'http://msplwa118.corp.medtronic.com:5555/restv2/test.resources:concat/callUrl?##projectName=CID_Demo&ioUrl=https%3A%2F%2Fmedtronicdevus.int-aws-us.webmethods.io' --header 'Authorization: Basic ##QWRtaW5pc3RyYXRvcjptYW5hZ2U=' --data ''
								##restv2/mdt_exportproject.resources:exportProject

		                ##curl --location "$premurl/restv2/mdt_exportproject.resources:exportProject/exportProject?projectName=$projectName&ioUrl=$ioIntUrl&ioenv=$wmioenv" --output ${projectName}.zip -H 'Content-Type:application/json' -H 'x-HTTP-Method-Override:GET'
				curl --location "https://wfapi-int-prod-01.s3.us-west-2.amazonaws.com/export-fl0eeead976cdc6e46ddd3f4-1708497294291.zip?AWSAccessKeyId=ASIA2JVTXLELIEMLR3X3&Expires=1708497894&Signature=lPkcSw8Gw2iV6sGc%2B%2FNyHwaZwqM%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEFcaCXVzLXdlc3QtMiJIMEYCIQCWeWHzv5ojHNdjNLOJa7vjkiA8wsg7q%2B49FDST5PI9KwIhALTValawnzXde00CaXWqAFPJ1BMKf%2Fcur6PIN%2FB1FfJyKoQFCEAQAhoMNzA3OTcyNzgyMzU4Igxi1kxRpUoWTNNBHygq4QSq%2BFreOe2A%2F2ejKs4p19ELYrbnO2kVqlgdKBXRYYdypYerJ9gx45XBuQh8UCQy2fGRmv4ujGVz3xIjEEgtEy2JtRTdjSenmjZiKBzPR9VHoq9ZTsDY94yAp0EzGmpBM2dAIylvrUgvdKnVg0gzUIchBOb14HqmzeeYnh5oJTkxtIXYcP%2BRfzS2qYXS0GbWNGVMj52IQg1RqrLo3AI%2FQqouzDb4YHo7N1VRaPP8wSUE4nyY9F6fMYxPlisqAgNE0GJvb16SxTNl8FW2ISbW2DgkPiI%2Bo9SaXNH56ZfsNhb%2FeGR2FmjSdtH2QlzVkcXUFI1Jiu%2BrDpMvmFrGbXAkxr91FsWwlbukcQdGxRhNb1bT90VPlUMYaQmSWAtin6Zmcq1%2BfgFDni4%2BAgXbh2cPphsKD%2B94%2FxqhXJvEuTYVoUx9fMKNv%2FJstoTcYWxQlrR%2FqMbqqG5oYz3sgElCuTEnqtLtPk6KjEtS19Kp5R%2BGlmmU2fs5r4vBk2FZCic0poKDqoFvn90e6wiwYK3O0bymGmcQIAAQv33FeqDToi9drq1sUpew9%2BULSm473OwLw8y42tvMrVOxxnwaT8BgtFr%2FiHOEz8ZFpfg0J8SrOMbZfSXdqmCRC4h4DCi1r%2BaiW2U%2Fccf1iRLvUF9FshXERhzQUArn3xQVOitqfB3xJIfVgpaHGJp2h3dYGIEhol8eDGY4o4kMi6NQjOLXFiXHoiAkWzh1nmLbapo80K1OFBCPwGSlKBFkHhD%2FK1F3E15PoFwXtfcmRJGQANXPEQ6L2%2BZ%2BA17LjlPrNCeGILQfBRzMgt%2BR4EkwjrPWrgY6mgHhDpZAscl23dE7mNJvqnf%2FwKcMFpNNnrVUhx7U71wlx9yHP9dMb68vEZNFvpmb9Kxepkq9gjjYG7f%2B1k00O2xUQArDFPj4Rm8LRVQrcAYd1B%2B8UubSh950FI62wdJY0m7dP5vAwTzhj%2F236FlEIIJNsx8RXBym102U5nHgDXob5I05Dyb4yCO%2FcBlWvT5vX0A05wRedmy8lLgl" --output ${projectName}.zip -H 'Content-Type:application/json' -H 'x-HTTP-Method-Override:GET'

						ls -lrt
						echo "${projectName}".zip
						cat  "${projectName}".zip | wc -l

						projContent=$(cat  "${projectName}".zip | wc -l)
						#projContent=$(zcat < "${projectName}".zip | grep -o '"statusofproject":"[^"]*' | grep -o '[^"]*$')
						echo $projContent
						
						##if [ ! -z "$projContent" ];   then
						 if [ $projContent -eq 2 ];   then
							echo "Export failed" 
							rm ${projectName}.zip
							ls -lrt
							exit 1

						else

							echo "Export Succeeded"
							ls -lrt
						
						fi


								echo "Export Succeeded"
								echo "Check-in the file"
								
								echo $(pwd)
								echo $(ls -lrt)

								git add $projectName.zip
								git config --global user.name "shilpm2"
                				git config --global user.email "shilpm2@locahost.com"
               					

                				git commit -m "Add $projectName to repo"
								
								sh '''

                				sh "git push -u origin DEV"
							
								}
							//sh 'chmod +x ../scripts/*.sh'
				//sh "source ../scripts/export_API.sh; export_api '${apiName}' '${wmioapi_url}' '${admin_user}' '${admin_password}' "
						                       

						}
					}                     
				
		}
	}	
 }
 }
