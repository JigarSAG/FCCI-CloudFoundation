#!/usr/bin/env groovy

pipeline 
{
    agent any 
    environment 
	{
	// initialize the variables
		branch="${branchName}"
		apis = ""		
 	}

    stages 
	{
	 stage('Initialize Repo')
	  {  
	   steps 
		{
		  script {
			iPaasEnv = "wmioINT"
			wmioenv = "DEV"
			echo "${iPaasEnv}"

			
			source_environment_hostname = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i hostname | cut -d '"' -f2 ''' ).trim()
			source_environment_port = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i port | cut -d '"' -f2 ''' ).trim()
			admin_user = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i admin_username | cut -d '"' -f2 ''' ).trim()
			source_type = sh ( returnStdout: true, script: '''cat configs/wmioINT/DEV.yml | grep -i type | cut -d '"' -f2 ''' ).trim()
			//repo_user = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/repo.yml | grep -i user | cut -d '"' -f2 ''' ).trim()
			LOCAL_DEV_URL = "https://${source_environment_hostname}:${source_environment_port}"
        //    onprem_user = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_username | cut -d '"' -f2 ''' ).trim()  
        //    onprem_pwd = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_pwd | cut -d '"' -f2 ''' ).trim() 
        //    onpremurl = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_url | cut -d '"' -f2 ''' ).trim()
        //    onpremport = sh ( returnStdout: true, script: '''cat configs/${iPaasEnv}/onprem.yml | grep -i onprem_prt | cut -d '"' -f2 ''' ).trim()
        //    inturl="${onpremurl}:${onpremport}"
		
			repo_user="JigarBharat.Shah@Softwareag.com"
			onprem_user="Administrator"
			onprem_pwd="manage"
			inturl="http://SAG-FMJB2F3:5401"
			}
			
		echo "${source_environment_hostname}"
		echo "${source_environment_port}"
    	echo "${admin_user}"
		echo "${source_type}"
		echo "${repo_user}"
        echo "${onprem_user}"
		echo "${onprem_pwd}"
		echo "${inturl}"
		
		}
	   }
	
	
	stage('Export Projects')
	 {
         steps {
		            sh 'pwd'
		            sh 'ls -lrt'

		            
                      		echo "Start exporting the project"
						script{
                            
							env.premurl=inturl
							echo "on-prem url is : ${premurl}"
							
							env.ioIntUrl=LOCAL_DEV_URL
							echo "io INT url is : ${ioIntUrl}"

			                dir('FCCI-CloudFoundation')
							{ 
		   			        sh 'pwd'
	   	   			        sh 'ls -ltr' 		
								echo "checkout"
							script {
								git branch: 'DEV',
								credentialsId: 'webm_credentials',
								url: 'https://github.com/JigarSAG/FCCI-CloudFoundation.git'

								sh "ls -lat"
				                	}
							
							
								if ("${projectName}" == '')
								{
									echo "Project name is not given"
                                	exit 0
								}
                            	else
								{
								echo "Project name is ${projectName}"
								
								sh '''
								echo $(pwd)
								echo $premurl

								cd export
								echo $(pwd)
								echo $(ls -lrt)

                               					cd project
								echo $(pwd)
								echo $(ls -lrt)

								echo ${ioIntUrl}
								echo ${premurl}

                        		##curl --location 'http://msplwa118.corp.medtronic.com:5555/restv2/test.resources:concat/callUrl?##projectName=CID_Demo&ioUrl=https%3A%2F%2Fmedtronicdevus.int-aws-us.webmethods.io' --header 'Authorization: Basic ##QWRtaW5pc3RyYXRvcjptYW5hZ2U=' --data ''
								##restv2/mdt_exportproject.resources:exportProject

		                ##curl --location "$premurl/restv2/mdt_exportproject.resources:exportProject/exportProject?projectName=$projectName&ioUrl=$ioIntUrl&ioenv=$wmioenv" --output ${projectName}.zip -H 'Content-Type:application/json' -H 'x-HTTP-Method-Override:GET'
				curl --location "https://wfapi-int-prod-01.s3.us-west-2.amazonaws.com/export-fl0eeead976cdc6e46ddd3f4-1708494219899.zip?AWSAccessKeyId=ASIA2JVTXLELLY45FGQ3&Expires=1708494820&Signature=1N6XyHbNcdLOQiw4Nl7XTR6JRDM%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEFYaCXVzLXdlc3QtMiJHMEUCID2HPGcQhDZtO8vobDORSA7ffgWN6BLYHvLzuJovB5NhAiEAk56K3FT%2FFvTYr1t9NJZsizmw3zpZQ6uqd53mcXulrMAqhAUIPxACGgw3MDc5NzI3ODIzNTgiDFek8XHzAurLIECCsCrhBONiE8L9%2FCS9aFfe9PEMvkh6zMUvm%2Fg12jX%2Bl8IMPf%2FngT57qqGvUV0QuQw8HxZiENq1IFnTcOJ25DZAO3uQI6uK6v9TQ9yV8t1uE%2BU%2BCpufTOywwotd6YKp8MJusxatLEjw%2FNK7GPYlc1IW3j9R5NbSY5rmeo5czhh6aPQd0okIi5yQFJXsAbSzQkHsh2%2BJ1ingtH%2BeQ9KiHbtl4HptDOViv6in0%2FINeXMj1b9NspRa9C2vTmN3rCMxbR5cgF11wV4hpKNBeJIu%2Bv1T%2FuNeklMmc1Dm6ylC7EK9Kzpg5VOGoGlHzfFq3RxOcV%2B8Zg7OuAvTCwDpe81VBLfjzu2RjiYpxZ%2F%2FDOi5OLo2LZJLHpsvqdzHgE%2BoPTQMBWzEmNTWlpnGruwXQvPfctm4T8B5wlgTRCB%2BFmWrVYx3CsLZi4lO1SUDKsCVbwYUqLKKKUTm7Cx2AqgXZLXDDRxe5qjV89fRO3JqAt9DC12jGDnJaThx48zLl8CavBEIwzbtA4eP%2B3te9Ox8%2BDXUv9D2SSm2MakQjF7fim2i0rb85JXwKIy5QSgQ%2BrRXsDFfkpZccKCNMn6nht7%2FfW%2FmOrhpQEvkHdfIVSnJ5zc1IgtB1eKg3WZnOtvnpYviZIQB3pRlDxuAvJWEd9LzAGRrhZAKv8fiFQYAfeUdAihRLW6ShrfbYeE%2FDfjG6k3A%2BVMTRFPC1v9l%2BpmaBrWhf97YZMmsHTM7cZHB%2Ff66cTVpIz3IGnLD%2FDtkT8%2Bj8yAr4v2UdSZRRhN1OuDbflV%2F8mJkmjT8n7k8p%2Fq%2FBVvdX%2F1Q%2FLG5Y4p4%2FHL%2FtzCLm9auBjqbAQaId%2B5YZTH3mMN3pzT%2BchVy%2B9ZzR6IoQ%2FFaDiBMgxko6fXDCoD3Ntd%2F7fVJ%2BgcGAZu9OBijI8R72uL9nhKr23UxPeocSBXKoo6iJ6%2FyyuYMzgRAbD6%2Fy1LjsN6SFENwC3zwwALu8xw8Xvy%2BLH0AZSCbYq6DYSnQTO5MOvaGt7Jkhmy7FfGK2MTHMeNkA8ctJYGXGAVaHT2yDoQa" --output ${projectName}.zip -H 'Content-Type:application/json' -H 'x-HTTP-Method-Override:GET'

						ls -lrt
						echo "${projectName}".zip
						cat  "${projectName}".zip | wc -l

						projContent=$(cat  "${projectName}".zip | wc -l)
						#projContent=$(zcat < "${projectName}".zip | grep -o '"statusofproject":"[^"]*' | grep -o '[^"]*$')
						echo $projContent
						
						##if [ ! -z "$projContent" ];   then
						 if [ $projContent -eq 2 ];   then
							echo "Export failed" 
							rm ${projectName}.zip
							ls -lrt
							exit 1

						else

							echo "Export Succeeded"
							ls -lrt
						
						fi


								echo "Export Succeeded"
								echo "Check-in the file"
								
								echo $(pwd)
								echo $(ls -lrt)

								git add $projectName.zip
								git config --global user.name "shilpm2"
                				git config --global user.email "shilpm2@locahost.com"
               					

                				git commit -m "Add $projectName to repo"
								
								sh '''

                				sh "git push -u origin DEV"
							
								}
							//sh 'chmod +x ../scripts/*.sh'
				//sh "source ../scripts/export_API.sh; export_api '${apiName}' '${wmioapi_url}' '${admin_user}' '${admin_password}' "
						                       

						}
					}                     
				
		}
	}	
 }
 }
